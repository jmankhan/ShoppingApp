stages:
  - build
  - deploy

build_docker:
  stage: build
  tags:
    - shell
  script:
    - docker build . -t shopping_app

deploy:
  stage: deploy
  tags:
    - shell
  script:
    - docker save --output shopping_app.tar shopping_app
    - ls
    - scp -i $perm shopping_app.tar ubuntu@34.235.171.4:./
    - ssh -i $perm ubuntu@34.235.171.4
    - docker stop shopping_app || true
    - docker rm shopping_app || true
    - docker load --input shopping_app.tar
    - sudo netstat -ntlp | grep LISTEN
    - docker run -d -p 80:3000 -e NODE_ENV='PROD' --name shopping_app shopping_app